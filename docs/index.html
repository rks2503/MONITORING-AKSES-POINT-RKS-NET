<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring MikroTik - M-CBBHasani</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .signal-good { color: #28a745; }
        .signal-weak { color: #ffc107; }
        .signal-poor { color: #dc3545; }
        #loading-spinner { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4"><i class="bi bi-router"></i> Dashboard Monitoring Akses Point</h1>
        
        <!-- Card Info Router -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informasi Router</h5>
            </div>
            <div class="card-body">
                <div id="router-info">
                    <p class="text-muted">Memuat data...</p>
                </div>
            </div>
        </div>

        <!-- Card Daftar Client -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-wifi"></i> Client Wireless Terhubung 
                    <span id="client-count-badge" class="badge bg-light text-dark ms-2">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Data
                    </button>
                    <div class="spinner-border text-primary" id="loading-spinner" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-sm" id="client-table">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>MAC Address</th>
                                <th>Interface</th>
                                <th>Sinyal</th>
                                <th>Uptime</th>
                                <th>TX Rate</th>
                                <th>RX Rate</th>
                            </tr>
                        </thead>
                        <tbody id="client-table-body">
                            <tr><td colspan="7" class="text-center text-muted">Tidak ada data client atau sedang memuat...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-muted small mt-3">
                    <i class="bi bi-clock"></i> Data diperbarui otomatis setiap 30 detik. Terakhir diperbarui: <span id="last-update">-</span>
                </p>
            </div>
        </div>
        
        <footer class="mt-4 text-center text-muted small">
            <p>Powered by MikroTik API &copy; 2024</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://api.cekrouter.cyou/api/all-clients';
        let autoRefreshInterval;

        // Fungsi utama mengambil data
        async function fetchData() {
            showLoading(true);
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.success && data.routers.length > 0) {
                    const router = data.routers[0]; // Ambil data router pertama
                    updateRouterInfo(router);
                    updateClientTable(router.wireless_clients || []);
                    updateLastUpdate();
                } else {
                    showError('Data dari API tidak sesuai format.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('Gagal mengambil data dari server.');
            } finally {
                showLoading(false);
            }
        }

        // Update info router
        function updateRouterInfo(router) {
            const infoDiv = document.getElementById('router-info');
            infoDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong><i class="bi bi-geo-alt"></i> Lokasi:</strong> ${router.router_location || 'N/A'}</p>
                        <p><strong><i class="bi bi-pc-display"></i> Identity:</strong> ${router.router_identity || 'N/A'}</p>
                        <p><strong><i class="bi bi-cpu"></i> Model:</strong> ${router.system?.board_name || 'N/A'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong><i class="bi bi-broadcast"></i> Versi OS:</strong> ${router.system?.version || 'N/A'}</p>
                        <p><strong><i class="bi bi-clock-history"></i> Uptime:</strong> ${router.system?.uptime || 'N/A'}</p>
                        <p><strong><i class="bi bi-speedometer2"></i> CPU Load:</strong> ${router.system?.cpu_load || 'N/A'}%</p>
                    </div>
                </div>
            `;
        }

        // Update tabel client
        function updateClientTable(clients) {
            const tableBody = document.getElementById('client-table-body');
            const badge = document.getElementById('client-count-badge');
            
            badge.textContent = clients.length;
            
            if (clients.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tidak ada client wireless yang terhubung.</td></tr>`;
                return;
            }
            
            let html = '';
            clients.forEach((client, index) => {
                const signalClass = getSignalClass(client.signal_strength);
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><code>${client.mac_address || 'N/A'}</code></td>
                        <td>${client.interface || 'N/A'}</td>
                        <td class="${signalClass}"><i class="bi bi-wifi"></i> ${client.signal_strength || 'N/A'}</td>
                        <td>${client.uptime || 'N/A'}</td>
                        <td>${client.tx_rate || 'N/A'}</td>
                        <td>${client.rx_rate || 'N/A'}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }

        // Helper: tentukan kelas CSS berdasarkan kekuatan sinyal
        function getSignalClass(signalStr) {
            if (!signalStr) return '';
            const signal = parseInt(signalStr.replace('dBm', '').trim());
            if (signal >= -60) return 'signal-good';
            if (signal >= -70) return 'signal-weak';
            return 'signal-poor';
        }

        // Update waktu terakhir refresh
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('id-ID');
        }

        // Tampilkan/sembunyikan loading spinner
        function showLoading(show) {
            document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
        }

        // Tampilkan pesan error
        function showError(message) {
            const tableBody = document.getElementById('client-table-body');
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger"><i class="bi bi-exclamation-triangle"></i> ${message}</td></tr>`;
        }

        // Fungsi refresh manual
        function refreshData() {
            clearInterval(autoRefreshInterval);
            fetchData();
            startAutoRefresh();
        }

        // Auto refresh setiap 30 detik
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(fetchData, 30000); // 30 detik
        }

        // Jalankan saat halaman pertama kali dimuat
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            startAutoRefresh();
        });
    </script>
</body>
</html>
