name: MikroTik Dashboard CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run setiap 6 jam untuk monitoring kontinu
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Manual trigger dari UI GitHub

env:
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.7.0'

jobs:
  test-connection:
    name: Test MikroTik Connection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install routeros-api python-dotenv pytest
        
    - name: Run connection test
      env:
        MIKROTIK_HOST: ${{ secrets.MIKROTIK_HOST }}
        MIKROTIK_USER: ${{ secrets.MIKROTIK_USER }}
        MIKROTIK_PASS: ${{ secrets.MIKROTIK_PASSWORD }}
        MIKROTIK_PORT: ${{ secrets.MIKROTIK_PORT || '7699' }}
      run: |
        echo "ðŸ”§ Testing connection to: $MIKROTIK_HOST:$MIKROTIK_PORT"
        python scripts/test_connection.py
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: connection-test-results
        path: |
          logs/
          test_results.json
          
  collect-metrics:
    name: Collect Router Metrics
    runs-on: ubuntu-latest
    needs: test-connection
    if: success()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: pip install routeros-api pandas
        
    - name: Collect router metrics
      env:
        MIKROTIK_HOST: ${{ secrets.MIKROTIK_HOST }}
        MIKROTIK_USER: ${{ secrets.MIKROTIK_USER }}
        MIKROTIK_PASS: ${{ secrets.MIKROTIK_PASSWORD }}
        MIKROTIK_PORT: ${{ secrets.MIKROTIK_PORT || '7699' }}
      run: |
        echo "ðŸ“Š Collecting router metrics..."
        python scripts/collect_metrics.py
        
    - name: Upload metrics data
      uses: actions/upload-artifact@v3
      with:
        name: router-metrics-${{ github.run_id }}
        path: data/metrics_*.json
        retention-days: 7
        
  deploy-dashboard:
    name: Deploy Dashboard
    runs-on: ubuntu-latest
    needs: [test-connection, collect-metrics]
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install gunicorn flask
        
    - name: Deploy to VPS (SSH)
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/var/www/mikrotik-dashboard' }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Deploy via rsync
        rsync -avz -e "ssh -o StrictHostKeyChecking=no" \
          --exclude '.git' \
          --exclude '.github' \
          --exclude '__pycache__' \
          ./ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          
        # Restart service on remote
        ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST \
          "cd $DEPLOY_PATH && sudo systemctl restart mikrotik-dashboard"
          
    - name: Send notification
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        author_name: GitHub Actions
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
