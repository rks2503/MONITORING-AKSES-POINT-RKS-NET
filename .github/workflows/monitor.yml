name: RKS NET Monitoring

on:
  # Run setiap 5 menit
  schedule:
    - cron: '*/5 * * * *'
  
  # Bisa run manual
  workflow_dispatch:
  
  # Run saat file monitoring berubah
  push:
    paths:
      - 'scripts/**'
      - 'config/**'
      - '.github/workflows/**'

# Permission untuk deploy ke GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install routeros-api pyyaml
        
    - name: Update Mikrotik config with secrets
      run: |
        # Replace placeholder dengan GitHub Secrets
        sed -i "s/IP_PUBLIC_GR3_ANDA/${{ secrets.GR3_IP }}/g" config/mikrotik_config.yaml
        sed -i "s/PASSWORD_ANDA/${{ secrets.GR3_PASS }}/g" config/mikrotik_config.yaml
        
    - name: Run monitoring
      run: |
        python scripts/monitor.py
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        keep_files: false
        
    - name: Telegram notification (Optional)
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -f data/status.json ]; then
          OFFLINE=$(python3 -c "import json; d=json.load(open('data/status.json')); print(d['summary']['offline_customers'])")
          if [ "$OFFLINE" -gt 0 ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="⚠️ RKS NET: $OFFLINE pelanggan OFFLINE" \
              -d parse_mode="HTML"
          fi
        fi
